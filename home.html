<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franse Woordenschat App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basisstijlen */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }

        /* Kaart flip effect */
        .card-flip {
            perspective: 1000px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flip.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Dynamische achtergrond- en tekstkleuren voor kaart voor/achter op basis van thema */
        /* Deze worden overschreven door JS voor dynamische theming */
        .card-front.light-mode { background-color: #ffffff; color: #333; }
        .card-front.dark-mode { background-color: #4a5568; color: #e2e8f0; }
        .card-back.light-mode { background-color: #edf2f7; color: #333; }
        .card-back.dark-mode { background-color: #2d3748; color: #e2e8f0; }

        /* Fade in down animatie voor berichten */
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.5s ease-out forwards;
        }

        /* Gethemede elementen */
        body.light-mode {
            background-color: #e0f2fe; /* blue-100 */
            color: #1f2937; /* gray-800 */
        }
        body.dark-mode {
            background-color: #1f2937; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        .panel {
            background-color: #ffffff;
            border-color: #e5e7eb; /* gray-200 */
        }
        .panel.dark-mode {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }
        .themed-input {
            border-color: #d1d5db; /* gray-300 */
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
        }
        .themed-input:focus {
            ring-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6; /* blue-500 */
        }
        .themed-input.dark-mode {
            border-color: #6b7280; /* gray-500 */
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        .themed-input.dark-mode:focus {
            ring-color: #60a5fa; /* blue-400 */
            border-color: #60a5fa; /* blue-400 */
        }
        .themed-list-item {
            background-color: #f9fafb; /* gray-50 */
            color: #1f2937; /* gray-800 */
        }
        .themed-list-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .themed-list-item.dark-mode {
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }
        .themed-list-item.dark-mode:hover {
            background-color: #6b7280; /* gray-500 */
        }
        .themed-sub-panel {
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
        }
        .themed-sub-panel.dark-mode {
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }
        #userNameDisplay {
            background-color: #ffffff;
            color: #4b5563; /* gray-600 */
        }
        #userNameDisplay.dark-mode {
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 text-gray-800">

    <h1 class="text-4xl font-bold text-blue-800 mb-6 drop-shadow-md">Franse Woordenschat</h1>

    <!-- Header Knoppen (Donkere Modus Schakelaar & Profiel) -->
    <div class="absolute top-4 right-4 flex space-x-2">
        <!-- Donkere Modus Schakelaar -->
        <button id="darkModeToggle" class="p-3 rounded-full shadow-lg transition-colors duration-300 bg-yellow-400 text-gray-800 hover:bg-yellow-500" aria-label="Schakel donkere modus">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm-4 8a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-4-4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm10.293-2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM5.293 4.293a1 1 0 010 1.414L4.586 6.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM14.707 14.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM4.293 14.707a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 8a2 2 0 100 4 2 2 0 000-4z"></path></svg>
        </button>
        <!-- Profiel Knop -->
        <button id="profileBtn" class="p-3 rounded-full shadow-lg transition-colors duration-300 bg-blue-500 text-white hover:bg-blue-600" aria-label="Open profielinstellingen">
            <i class="fas fa-user"></i>
        </button>
    </div>

    <!-- Berichtenweergave -->
    <div id="messageDisplay" class="hidden bg-yellow-200 text-yellow-800 p-3 rounded-lg mb-4 shadow-md"></div>

    <!-- Gebruikersnaam Weergave -->
    <div id="userNameDisplay" class="text-sm mb-4 p-2 rounded-lg shadow-sm">
        Welkom, <span id="userNameSpan" class="font-bold text-blue-700">Gast</span>!
    </div>

    <!-- Hoofdinhoud van de App -->
    <div id="mainAppContent" class="w-full flex flex-col items-center">
        <!-- Navigatie Knoppen -->
        <div class="flex space-x-4 mb-8">
            <button id="viewSetsBtn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-lg bg-blue-600 text-white transform scale-105">
                Mijn Sets
            </button>
            <button id="createSetBtn" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-lg bg-green-500 text-white hover:bg-green-600">
                Nieuwe Set
            </button>
            <button id="addWordsBtn" class="hidden px-6 py-3 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-lg bg-purple-500 text-white hover:bg-purple-600">
                Woorden Toevoegen
            </button>
        </div>

        <!-- Hoofdinhoudsgebied -->
        <div id="contentArea" class="w-full max-w-2xl p-6 rounded-xl shadow-xl border panel">
            <!-- Inhoud wordt hier dynamisch geladen door JavaScript -->
        </div>
    </div>

    <!-- Firebase SDK en Applicatielogica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // --- Globale Applicatiestatus Variabelen ---
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false; // Vlag om te zorgen dat authenticatie voltooid is voordat Firestore-operaties starten

        let sets = []; // Slaat alle woordenschatsets op voor de huidige gebruiker
        let selectedSet = null; // De momenteel geselecteerde set om te leren of te bewerken
        let currentWordIndex = 0; // Index voor het huidige woord in de leermodus
        let showTranslation = false; // Voor flashcard-modus: true om Nederlands te tonen, false voor Frans

        let currentMode = 'viewSets'; // 'viewSets', 'createSet', 'learnSet', 'addWords'
        let learnSubMode = 'flashcards'; // 'flashcards', 'quiz'
        let quizStrictness = 'loose'; // 'strict' (exacte match) of 'loose' (negeer hoofdletters/accenten)

        let isDarkMode = false; // Themastatus
        let userName = 'Gast'; // Standaard gebruikersnaam

        // --- DOM Elementen ---
        const messageDisplay = document.getElementById('messageDisplay');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userNameSpan = document.getElementById('userNameSpan');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const profileBtn = document.getElementById('profileBtn');
        const body = document.body;
        const mainAppContent = document.getElementById('mainAppContent');
        const contentArea = document.getElementById('contentArea');
        const viewSetsBtn = document.getElementById('viewSetsBtn');
        const createSetBtn = document.getElementById('createSetBtn');
        const addWordsBtn = document.getElementById('addWordsBtn');

        let messageTimeout = null;

        // --- Hulpfuncties ---
        function showMessage(msg, isError = true) {
            messageDisplay.textContent = msg;
            messageDisplay.classList.remove('hidden', 'bg-yellow-200', 'bg-green-200', 'text-yellow-800', 'text-green-800', 'text-red-500');
            if (isError) {
                messageDisplay.classList.add('bg-red-200', 'text-red-800');
            } else {
                messageDisplay.classList.add('bg-green-200', 'text-green-800');
            }
            messageDisplay.classList.add('animate-fade-in-down');

            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            messageTimeout = setTimeout(() => {
                messageDisplay.classList.add('hidden');
                messageDisplay.classList.remove('animate-fade-in-down');
            }, 3000);
        }

        function normalizeString(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        function applyTheme() {
            isDarkMode = localStorage.getItem('isDarkMode') === 'true'; // Haal thema op uit localStorage

            if (isDarkMode) {
                body.classList.add('dark-mode');
                body.classList.remove('light-mode', 'bg-gradient-to-br', 'from-blue-100', 'to-purple-100', 'text-gray-800');
                body.classList.add('bg-gray-900', 'text-gray-100');

                darkModeToggle.classList.remove('bg-yellow-400', 'text-gray-800', 'hover:bg-yellow-500');
                darkModeToggle.classList.add('bg-gray-600', 'text-yellow-300', 'hover:bg-gray-500');
                darkModeToggle.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>';
            } else {
                body.classList.remove('dark-mode', 'bg-gray-900', 'text-gray-100');
                body.classList.add('light-mode', 'bg-gradient-to-br', 'from-blue-100', 'to-purple-100', 'text-gray-800');

                darkModeToggle.classList.remove('bg-gray-600', 'text-yellow-300', 'hover:bg-gray-500');
                darkModeToggle.classList.add('bg-yellow-400', 'text-gray-800', 'hover:bg-yellow-500');
                darkModeToggle.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm-4 8a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-4-4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm10.293-2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM5.293 4.293a1 1 0 010 1.414L4.586 6.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM14.707 14.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM4.293 14.707a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 8a2 2 0 100 4 2 2 0 000-4z"></path></svg>';
            }

            // Werk paneel (container) achtergrond en rand bij
            document.querySelectorAll('.panel').forEach(panel => {
                if (isDarkMode) {
                    panel.classList.remove('bg-white', 'border-gray-200');
                    panel.classList.add('bg-gray-700', 'border-gray-600');
                } else {
                    panel.classList.remove('bg-gray-700', 'border-gray-600');
                    panel.classList.add('bg-white', 'border-gray-200');
                }
            });

            // Werk invoerveldstijlen bij
            document.querySelectorAll('.themed-input').forEach(input => {
                if (isDarkMode) {
                    input.classList.remove('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500', 'bg-white', 'text-gray-800');
                    input.classList.add('border-gray-500', 'focus:ring-blue-400', 'focus:border-blue-400', 'bg-gray-800', 'text-gray-100');
                } else {
                    input.classList.remove('border-gray-500', 'focus:ring-blue-400', 'focus:border-blue-400', 'bg-gray-800', 'text-gray-100');
                    input.classList.add('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500', 'bg-white', 'text-gray-800');
                }
            });

            // Werk lijstitemstijlen bij
            document.querySelectorAll('.themed-list-item').forEach(item => {
                if (isDarkMode) {
                    item.classList.remove('bg-gray-50', 'hover:bg-gray-100', 'text-gray-800');
                    item.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-gray-100');
                } else {
                    item.classList.remove('bg-gray-600', 'hover:bg-gray-500', 'text-gray-100');
                    item.classList.add('bg-gray-50', 'hover:bg-gray-100', 'text-gray-800');
                }
            });

            // Werk sub-paneelstijlen bij (bijv. quiz strengheidsbox)
            document.querySelectorAll('.themed-sub-panel').forEach(panel => {
                if (isDarkMode) {
                    panel.classList.remove('bg-gray-100', 'text-gray-700');
                    panel.classList.add('bg-gray-600', 'text-gray-200');
                } else {
                    panel.classList.remove('bg-gray-600', 'text-gray-200');
                    panel.classList.add('bg-gray-100', 'text-gray-700');
                }
            });

            // Werk gebruikersnaam weergavepaneel bij
            if (userNameDisplay) {
                if (isDarkMode) {
                    userNameDisplay.classList.remove('bg-white', 'text-gray-600');
                    userNameDisplay.classList.add('bg-gray-600', 'text-gray-200');
                } else {
                    userNameDisplay.classList.remove('bg-gray-600', 'text-gray-200');
                    userNameDisplay.classList.add('bg-white', 'text-gray-600');
                }
            }

            // Werk kaart voor/achter kleuren dynamisch bij
            document.querySelectorAll('.card-front').forEach(card => {
                card.classList.remove('light-mode', 'dark-mode');
                card.classList.add(isDarkMode ? 'dark-mode' : 'light-mode');
            });
            document.querySelectorAll('.card-back').forEach(card => {
                card.classList.remove('light-mode', 'dark-mode');
                card.classList.add(isDarkMode ? 'dark-mode' : 'light-mode');
            });
        }

        // --- Firebase Initialisatie ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : `{
                    "apiKey": "AIzaSyB59BVbioUciigC0l47T1tQAsF_kPs2Frs",
                    "authDomain": "leer-app.firebaseapp.com",
                    "projectId": "leer-app",
                    "storageBucket": "leer-app.firebasestorage.app",
                    "messagingSenderId": "1029710103221",
                    "appId": "1:1029710103221:web:386173aefbed03015574fc"
                }`);

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        profileBtn.classList.remove('hidden'); // Toon profielknop
                        await loadUserProfile(); // Laad gebruikersprofiel (naam, donkere modus voorkeur)
                        setupSetsListener(); // Start luisteren naar sets
                        setMode('viewSets'); // Initialiseer inhoudsgebied
                        mainAppContent.classList.remove('hidden'); // Toon hoofdinhoud
                    } else {
                        // Gebruiker is NIET ingelogd, stuur door naar index.html
                        window.location.href = 'index.html';
                    }
                });
            } catch (error) {
                showMessage(`Fout bij initialiseren Firebase: ${error.message}`);
                console.error("Error initializing Firebase:", error);
            }
        }

        // --- Gebruikersprofiel Beheer (Firestore) ---
        async function loadUserProfile() {
            if (!db || !currentUserId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userProfile`, 'settings');

            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userName = data.name || 'Gast';
                    isDarkMode = data.isDarkMode || false;
                    localStorage.setItem('isDarkMode', isDarkMode); // Opslaan in local storage
                    userNameSpan.textContent = userName; // Werk hoofdweergave bij
                    applyTheme(); // Pas thema toe op basis van geladen voorkeur
                } else {
                    // Als er geen profiel bestaat, maak er dan een aan met standaardwaarden
                    await setDoc(userProfileDocRef, {
                        name: userName,
                        isDarkMode: isDarkMode
                    });
                    localStorage.setItem('isDarkMode', isDarkMode); // Opslaan in local storage
                }
            } catch (error) {
                showMessage(`Fout bij laden profiel: ${error.message}`);
                console.error("Error loading user profile:", error);
            }
        }

        async function saveUserProfile() {
            if (!db || !currentUserId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userProfile`, 'settings');

            try {
                await updateDoc(userProfileDocRef, {
                    name: userName,
                    isDarkMode: isDarkMode
                });
                localStorage.setItem('isDarkMode', isDarkMode); // Werk local storage bij
                showMessage("Profiel opgeslagen!", false);
            }
            catch (error) {
                showMessage(`Fout bij opslaan profiel: ${error.message}`);
                console.error("Error saving user profile:", error);
            }
        }

        // --- Gegevensbeheer (Firestore voor Sets) ---
        let unsubscribeSets = null;

        function setupSetsListener() {
            if (db && currentUserId && isAuthReady) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userSetsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sets`);

                if (unsubscribeSets) {
                    unsubscribeSets();
                }

                unsubscribeSets = onSnapshot(userSetsCollectionRef, (snapshot) => {
                    sets = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    sets.sort((a, b) => a.title.localeCompare(b.title));
                    if (currentMode === 'viewSets') {
                        renderViewSets();
                    } else if (currentMode === 'addWords' && selectedSet) {
                        selectedSet = sets.find(s => s.id === selectedSet.id) || null;
                        if (selectedSet) {
                            renderAddWords();
                        } else {
                            setMode('viewSets');
                        }
                    } else if (currentMode === 'learnSet' && selectedSet) {
                        selectedSet = sets.find(s => s.id === selectedSet.id) || null;
                        if (!selectedSet || !selectedSet.words || selectedSet.words.length === 0) {
                            setMode('viewSets');
                        } else {
                            renderLearnSet();
                        }
                    }
                }, (error) => {
                    showMessage(`Fout bij ophalen sets: ${error.message}`);
                    console.error("Error fetching sets:", error);
                });
            }
        }

        async function createNewSet(setName) {
            if (!setName.trim()) {
                showMessage("Setnaam mag niet leeg zijn.");
                return;
            }
            if (!db || !currentUserId) {
                showMessage("Authenticatie niet voltooid. Probeer opnieuw.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userSetsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sets`);
                await addDoc(userSetsCollectionRef, {
                    title: setName.trim(),
                    words: []
                });
                showMessage("Set succesvol aangemaakt!", false);
                setMode('viewSets');
            } catch (error) {
                showMessage(`Fout bij aanmaken set: ${error.message}`);
                console.error("Error creating set:", error);
            }
        }

        async function addWordToSet(frenchWord, dutchTranslation) {
            if (!frenchWord.trim() || !dutchTranslation.trim()) {
                showMessage("Beide velden (Frans en Nederlands) moeten ingevuld zijn.");
                return;
            }
            if (!db || !currentUserId || !selectedSet) {
                showMessage("Geen set geselecteerd of authenticatie niet voltooid.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const setDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/sets`, selectedSet.id);

                const newWord = {
                    french: frenchWord.trim(),
                    dutch: dutchTranslation.trim()
                };

                const updatedWords = [...(selectedSet.words || []), newWord];
                await updateDoc(setDocRef, { words: updatedWords });
                showMessage("Woord succesvol toegevoegd!", false);
            } catch (error) {
                showMessage(`Fout bij toevoegen woord: ${error.message}`);
                console.error("Error adding word:", error);
            }
        }

        async function deleteWordFromSet(wordToDelete) {
            if (!db || !currentUserId || !selectedSet) {
                showMessage("Geen set geselecteerd of authenticatie niet voltooid.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const setDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/sets`, selectedSet.id);

                const updatedWords = (selectedSet.words || []).filter(
                    word => word.french !== wordToDelete.french || word.dutch !== wordToDelete.dutch
                );

                await updateDoc(setDocRef, { words: updatedWords });
                showMessage("Woord succesvol verwijderd!", false);
            } catch (error) {
                showMessage(`Fout bij verwijderen woord: ${error.message}`);
                console.error("Error deleting word:", error);
            }
        }

        async function deleteVocabularySet(setId) {
            if (!db || !currentUserId) {
                showMessage("Authenticatie niet voltooid.");
                return;
            }
            if (!window.confirm("Weet je zeker dat je deze set wilt verwijderen?")) {
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const setDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/sets`, setId);
                await deleteDoc(setDocRef);
                showMessage("Set succesvol verwijderd!", false);
                if (selectedSet && selectedSet.id === setId) {
                    selectedSet = null;
                    setMode('viewSets');
                }
            } catch (error) {
                showMessage(`Fout bij verwijderen set: ${error.message}`);
                console.error("Error deleting set:", error);
            }
        }

        // --- UI Rendering Functies ---
        function setMode(newMode) {
            currentMode = newMode;
            contentArea.dataset.mode = newMode;

            viewSetsBtn.classList.remove('bg-blue-600', 'transform', 'scale-105');
            viewSetsBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            createSetBtn.classList.remove('bg-green-600', 'transform', 'scale-105');
            createSetBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            addWordsBtn.classList.add('hidden');

            if (selectedSet) {
                addWordsBtn.classList.remove('hidden');
                addWordsBtn.textContent = `Woorden Toevoegen aan "${selectedSet.title}"`;
                if (newMode === 'addWords') {
                    addWordsBtn.classList.add('bg-purple-600', 'transform', 'scale-105');
                    addWordsBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                } else {
                    addWordsBtn.classList.remove('bg-purple-600', 'transform', 'scale-105');
                    addWordsBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                }
            }

            if (newMode === 'viewSets') {
                viewSetsBtn.classList.add('bg-blue-600', 'transform', 'scale-105');
                viewSetsBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                renderViewSets();
            } else if (newMode === 'createSet') {
                createSetBtn.classList.add('bg-green-600', 'transform', 'scale-105');
                createSetBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                renderCreateSet();
            } else if (newMode === 'learnSet' && selectedSet) {
                renderLearnSet();
            } else if (newMode === 'addWords' && selectedSet) {
                renderAddWords();
            }
            applyTheme();
        }

        function renderViewSets() {
            selectedSet = null;
            addWordsBtn.classList.add('hidden');
            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 ${isDarkMode ? 'text-gray-100' : 'text-gray-700'}">Jouw Woordenschat Sets</h2>
                <div id="setsList" class="space-y-3"></div>
            `;
            const setsList = document.getElementById('setsList');

            if (sets.length === 0) {
                setsList.innerHTML = `<p class="${isDarkMode ? 'text-gray-300' : 'text-gray-500'}">Nog geen sets aangemaakt. Maak er een aan om te beginnen!</p>`;
            } else {
                sets.forEach(set => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex items-center justify-between p-4 rounded-lg shadow-sm transition-colors duration-200 themed-list-item`;
                    listItem.innerHTML = `
                        <span class="text-lg font-medium">${set.title} (${set.words?.length || 0} woorden)</span>
                        <div class="flex space-x-2">
                            <button data-set-id="${set.id}" class="select-set-btn px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors duration-200 shadow-md">
                                Leren
                            </button>
                            <button data-set-id="${set.id}" class="add-words-to-set-btn px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors duration-200 shadow-md">
                                <i class="fas fa-plus"></i> Woorden
                            </button>
                            <button data-set-id="${set.id}" class="delete-set-btn px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 shadow-md">
                                <i class="fas fa-trash"></i> Verwijderen
                            </button>
                        </div>
                    `;
                    setsList.appendChild(listItem);
                });

                document.querySelectorAll('.select-set-btn').forEach(button => {
                    button.onclick = (e) => {
                        const setId = e.target.dataset.setId;
                        selectedSet = sets.find(s => s.id === setId);
                        currentWordIndex = 0;
                        showTranslation = false;
                        learnSubMode = 'flashcards';
                        setMode('learnSet');
                    };
                });
                document.querySelectorAll('.add-words-to-set-btn').forEach(button => {
                    button.onclick = (e) => {
                        const setId = e.target.dataset.setId;
                        selectedSet = sets.find(s => s.id === setId);
                        setMode('addWords');
                    };
                });
                document.querySelectorAll('.delete-set-btn').forEach(button => {
                    button.onclick = (e) => {
                        const setId = e.target.dataset.setId;
                        deleteVocabularySet(setId);
                    };
                });
            }
            contentArea.classList.add('panel');
            applyTheme();
        }

        function renderCreateSet() {
            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 ${isDarkMode ? 'text-gray-100' : 'text-gray-700'}">Nieuwe Set Aanmaken</h2>
                <input type="text" id="newSetNameInput" placeholder="Naam van de set (bijv. 'Reiswoorden')" class="w-full p-3 rounded-lg mb-4 themed-input">
                <button id="createSetSubmitBtn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md">
                    Set Aanmaken
                </button>
            `;
            const newSetNameInput = document.getElementById('newSetNameInput');
            newSetNameInput.value = '';
            document.getElementById('createSetSubmitBtn').onclick = () => {
                createNewSet(newSetNameInput.value);
            };
            contentArea.classList.add('panel');
            applyTheme();
        }

        function renderLearnSet() {
            if (!selectedSet || !selectedSet.words || selectedSet.words.length === 0) {
                contentArea.innerHTML = `
                    <p class="${isDarkMode ? 'text-gray-300' : 'text-gray-500'}">Deze set bevat nog geen woorden. Voeg woorden toe!</p>
                    <button id="backToSetsBtn" class="mt-6 px-6 py-3 bg-red-500 text-white rounded-full font-semibold hover:bg-red-600 transition-colors duration-200 shadow-md">
                        Terug naar Sets
                    </button>`;
                document.getElementById('backToSetsBtn').onclick = () => setMode('viewSets');
                contentArea.classList.add('panel');
                applyTheme();
                return;
            }

            const currentWord = selectedSet.words[currentWordIndex];

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 ${isDarkMode ? 'text-gray-100' : 'text-gray-700'}">Leren: ${selectedSet.title}</h2>
                <div class="flex space-x-4 mb-6">
                    <button id="flashcardsModeBtn" class="px-4 py-2 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-md"></button>
                    <button id="quizModeBtn" class="px-4 py-2 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-md"></button>
                </div>
                <div id="learnContent" class="w-full flex flex-col items-center"></div>
                <div class="text-gray-600 mb-6 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}">
                    Woord ${currentWordIndex + 1} van ${selectedSet.words.length}
                </div>
                <div class="flex space-x-4">
                    <button id="prevWordBtn" class="px-6 py-3 rounded-full font-semibold transition-colors duration-200 shadow-md ${isDarkMode ? 'bg-gray-500 text-gray-100 hover:bg-gray-400' : 'bg-gray-300 text-gray-800 hover:bg-gray-400'}">
                        Vorige
                    </button>
                    <button id="nextWordBtn" class="px-6 py-3 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        Volgende
                    </button>
                </div>
                <button id="backToSetsBtn" class="mt-6 px-6 py-3 bg-red-500 text-white rounded-full font-semibold hover:bg-red-600 transition-colors duration-200 shadow-md">
                    Terug naar Sets
                </button>
            `;

            const flashcardsModeBtn = document.getElementById('flashcardsModeBtn');
            const quizModeBtn = document.getElementById('quizModeBtn');
            const learnContent = document.getElementById('learnContent');
            const prevWordBtn = document.getElementById('prevWordBtn');
            const nextWordBtn = document.getElementById('nextWordBtn');
            const backToSetsBtn = document.getElementById('backToSetsBtn');

            flashcardsModeBtn.textContent = 'Flashcards';
            quizModeBtn.textContent = 'Quiz';

            function updateLearnSubModeButtons() {
                flashcardsModeBtn.className = `px-4 py-2 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-md ${learnSubMode === 'flashcards' ? 'bg-indigo-600 text-white' : 'bg-indigo-400 text-white hover:bg-indigo-500'}`;
                quizModeBtn.className = `px-4 py-2 rounded-full font-semibold transition-all duration-300 ease-in-out shadow-md ${learnSubMode === 'quiz' ? 'bg-indigo-600 text-white' : 'bg-indigo-400 text-white hover:bg-indigo-500'}`;
            }

            function renderLearnContent() {
                if (learnSubMode === 'flashcards') {
                    learnContent.innerHTML = `
                        <div id="cardFlipContainer" class="card-flip w-full h-64 mb-6 cursor-pointer ${showTranslation ? 'flipped' : ''}">
                            <div class="card-inner">
                                <div class="card-front ${isDarkMode ? 'dark-mode' : 'light-mode'}">
                                    <span class="text-3xl font-bold text-blue-700">${currentWord.french}</span>
                                </div>
                                <div class="card-back ${isDarkMode ? 'dark-mode' : 'light-mode'}">
                                    <span class="text-3xl font-bold text-purple-700">${currentWord.dutch}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('cardFlipContainer').onclick = () => {
                        showTranslation = !showTranslation;
                        renderLearnContent();
                    };
                } else if (learnSubMode === 'quiz') {
                    learnContent.innerHTML = `
                        <div class="w-full p-6 rounded-xl shadow-xl border panel">
                            <span class="text-3xl font-bold text-blue-700">${currentWord.french}</span>
                        </div>
                        <input type="text" id="quizAnswerInput" placeholder="Jouw vertaling in het Nederlands" class="w-full p-3 rounded-lg mb-4 text-center themed-input">
                        <button id="checkAnswerBtn" class="px-6 py-3 bg-green-500 text-white rounded-full font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md mb-4">
                            Controleer Antwoord
                        </button>
                        <p id="quizFeedback" class="font-semibold text-lg animate-fade-in-down"></p>
                        <div class="mt-4 p-4 rounded-lg shadow-inner themed-sub-panel">
                            <h4 class="font-semibold mb-2">Quiz Strengheid:</h4>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio text-blue-600" name="quizStrictness" value="loose" ${quizStrictness === 'loose' ? 'checked' : ''}>
                                    <span class="ml-2">Losjes (negeer hoofdletters/accenten)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio text-blue-600" name="quizStrictness" value="strict" ${quizStrictness === 'strict' ? 'checked' : ''}>
                                    <span class="ml-2">Streng (exacte match)</span>
                                </label>
                            </div>
                        </div>
                    `;
                    const quizAnswerInput = document.getElementById('quizAnswerInput');
                    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
                    const quizFeedbackEl = document.getElementById('quizFeedback');

                    quizAnswerInput.value = '';
                    quizFeedbackEl.textContent = '';

                    checkAnswerBtn.onclick = () => {
                        const userAnswer = quizAnswerInput.value;
                        const correctTranslation = currentWord.dutch;
                        let isCorrect = false;

                        if (quizStrictness === 'strict') {
                            isCorrect = (userAnswer === correctTranslation);
                        } else {
                            isCorrect = (normalizeString(userAnswer) === normalizeString(correctTranslation));
                        }

                        if (isCorrect) {
                            quizFeedbackEl.textContent = "Correct!";
                            quizFeedbackEl.classList.remove('text-red-500');
                            quizFeedbackEl.classList.add('text-green-500');
                            showMessage("Correct!", false);
                        } else {
                            quizFeedbackEl.textContent = `Onjuist. Het juiste antwoord is: ${correctTranslation}`;
                            quizFeedbackEl.classList.remove('text-green-500');
                            quizFeedbackEl.classList.add('text-red-500');
                            showMessage("Onjuist.");
                        }
                    };

                    document.querySelectorAll('input[name="quizStrictness"]').forEach(radio => {
                        radio.onchange = (e) => {
                            quizStrictness = e.target.value;
                            showMessage(`Quiz strengheid ingesteld op: ${quizStrictness === 'loose' ? 'Losjes' : 'Streng'}`, false);
                        };
                    });
                }
                applyTheme();
            }

            updateLearnSubModeButtons();
            renderLearnContent();

            flashcardsModeBtn.onclick = () => {
                learnSubMode = 'flashcards';
                currentWordIndex = 0;
                showTranslation = false;
                updateLearnSubModeButtons();
                renderLearnContent();
            };
            quizModeBtn.onclick = () => {
                learnSubMode = 'quiz';
                currentWordIndex = 0;
                showTranslation = false;
                updateLearnSubModeButtons();
                renderLearnContent();
            };

            prevWordBtn.onclick = () => {
                currentWordIndex = (currentWordIndex - 1 + selectedSet.words.length) % selectedSet.words.length;
                showTranslation = false;
                renderLearnContent();
            };
            nextWordBtn.onclick = () => {
                currentWordIndex = (currentWordIndex + 1) % selectedSet.words.length;
                showTranslation = false;
                renderLearnContent();
            };
            backToSetsBtn.onclick = () => setMode('viewSets');
            contentArea.classList.add('panel');
            applyTheme();
        }

        function renderAddWords() {
            if (!selectedSet) {
                showMessage("Geen set geselecteerd.");
                setMode('viewSets');
                return;
            }

            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 ${isDarkMode ? 'text-gray-100' : 'text-gray-700'}">Woorden Toevoegen aan: ${selectedSet.title}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <input type="text" id="newFrenchWordInput" placeholder="Frans woord" class="p-3 rounded-lg themed-input">
                    <input type="text" id="newDutchTranslationInput" placeholder="Nederlandse vertaling" class="p-3 rounded-lg themed-input">
                </div>
                <button id="addWordSubmitBtn" class="w-full bg-purple-500 text-white py-3 rounded-lg font-semibold hover:bg-purple-600 transition-colors duration-200 shadow-md mb-6">
                    Woord Toevoegen
                </button>

                <h3 class="text-xl font-semibold mb-3 ${isDarkMode ? 'text-gray-100' : 'text-gray-700'}">Huidige woorden in deze set:</h3>
                <ul id="wordsList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                <button id="backToSetsFromAddWordsBtn" class="mt-6 px-6 py-3 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200 shadow-md">
                    Terug naar Sets
                </button>
            `;

            const newFrenchWordInput = document.getElementById('newFrenchWordInput');
            const newDutchTranslationInput = document.getElementById('newDutchTranslationInput');
            const addWordSubmitBtn = document.getElementById('addWordSubmitBtn');
            const wordsList = document.getElementById('wordsList');
            const backToSetsFromAddWordsBtn = document.getElementById('backToSetsFromAddWordsBtn');

            addWordSubmitBtn.onclick = () => {
                addWordToSet(newFrenchWordInput.value, newDutchTranslationInput.value);
                newFrenchWordInput.value = '';
                newDutchTranslationInput.value = '';
            };

            if (selectedSet.words && selectedSet.words.length > 0) {
                selectedSet.words.forEach((word, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex items-center justify-between p-3 rounded-lg shadow-sm themed-list-item`;
                    listItem.innerHTML = `
                        <span>
                            <span class="font-medium text-blue-700">${word.french}</span> - ${word.dutch}
                        </span>
                        <button data-french="${word.french}" data-dutch="${word.dutch}" class="delete-word-btn px-3 py-1 bg-red-400 text-white text-sm rounded-md hover:bg-red-500 transition-colors duration-200">
                            Verwijder
                        </button>
                    `;
                    wordsList.appendChild(listItem);
                });

                document.querySelectorAll('.delete-word-btn').forEach(button => {
                    button.onclick = (e) => {
                        const french = e.target.dataset.french;
                        const dutch = e.target.dataset.dutch;
                        deleteWordFromSet({ french, dutch });
                    };
                });
            } else {
                wordsList.innerHTML = `<p class="${isDarkMode ? 'text-gray-300' : 'text-gray-500'}">Deze set bevat nog geen woorden.</p>`;
            }

            backToSetsFromAddWordsBtn.onclick = () => setMode('viewSets');
            contentArea.classList.add('panel');
            applyTheme();
        }

        // --- Event Listeners voor Hoofdnavigatie ---
        viewSetsBtn.onclick = () => setMode('viewSets');
        createSetBtn.onclick = () => setMode('createSet');
        addWordsBtn.onclick = () => setMode('addWords');

        // Event listener voor Donkere Modus Schakelaar (hoofdknop)
        darkModeToggle.onclick = () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem('isDarkMode', isDarkMode); // Voorkeur opslaan
            applyTheme();
            saveUserProfile(); // Ook opslaan in Firestore
        };

        // Event listener voor Profielknop
        profileBtn.onclick = () => {
            window.location.href = 'profile.html';
        };

        // --- InitiÃ«le Setup bij Venster Laden ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
