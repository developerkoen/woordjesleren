<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profiel - Franse Woordenschat App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .full-page-content {
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, color 0.3s;
            position: relative; /* Nodig voor absolute positionering van terugknop */
        }
        .themed-input {
            border-color: #d1d5db; /* gray-300 */
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
        }
        .themed-input:focus {
            ring-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6; /* blue-500 */
        }
        /* Donkere modus overschrijvingen voor specifieke elementen */
        body.dark-mode {
            background-color: #1f2937; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        .full-page-content.dark-mode {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            border-color: #4b5563; /* gray-600 */
        }
        .themed-input.dark-mode {
            border-color: #6b7280; /* gray-500 */
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        .themed-input.dark-mode:focus {
            ring-color: #60a5fa; /* blue-400 */
            border-color: #60a5fa; /* blue-400 */
        }
        #profileBackBtn.light-mode {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
        }
        #profileBackBtn.dark-mode {
            background-color: #4b5563; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
        }
        #profileMessage {
            animation: fade-in-down 0.5s ease-out forwards;
        }
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 text-gray-800">

    <h1 class="text-4xl font-bold text-blue-800 mb-6 drop-shadow-md">Franse Woordenschat</h1>

    <!-- Profielpagina Inhoud -->
    <div id="profilePageContent" class="full-page-content border border-gray-200">
        <button id="profileBackBtn" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-300 transition-colors duration-200" aria-label="Terug naar app">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Profiel Instellingen</h2>

        <div class="mb-4">
            <label for="userNameInput" class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Jouw Naam:</label>
            <input type="text" id="userNameInput" placeholder="Voer je naam in" class="w-full p-3 rounded-lg themed-input">
        </div>

        <div class="mb-4">
            <label for="profileEmailDisplay" class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">E-mail:</label>
            <input type="email" id="profileEmailDisplay" class="w-full p-3 rounded-lg themed-input bg-gray-100 cursor-not-allowed dark:bg-gray-800" disabled>
        </div>

        <div class="mb-4">
            <label for="newPasswordInput" class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Nieuw Wachtwoord (min. 6 tekens):</label>
            <input type="password" id="newPasswordInput" placeholder="Laat leeg om niet te wijzigen" class="w-full p-3 rounded-lg themed-input">
        </div>

        <div class="mb-6">
            <label for="confirmNewPasswordInput" class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Bevestig Nieuw Wachtwoord:</label>
            <input type="password" id="confirmNewPasswordInput" placeholder="Herhaal nieuw wachtwoord" class="w-full p-3 rounded-lg themed-input">
        </div>
        <button id="updatePasswordBtn" class="w-full px-6 py-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition-colors duration-200 shadow-md mb-4">
            Wachtwoord Wijzigen
        </button>
        <p id="profileMessage" class="text-sm text-red-500 mt-2"></p>


        <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Donkere Modus:</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" value="" id="profileDarkModeToggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            </label>
        </div>

        <p class="text-sm text-gray-500 mb-6">Je gebruikers-ID: <span id="profileUserIdSpan" class="font-mono text-blue-700 dark:text-blue-300"></span></p>

        <button id="logoutBtn" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors duration-200 shadow-md">
            Uitloggen
        </button>
    </div>

    <!-- Firebase SDK en Applicatielogica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // --- Globale Applicatiestatus Variabelen ---
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        let isDarkMode = false; // Themastatus
        let userName = 'Gast'; // Standaard gebruikersnaam

        // --- DOM Elementen ---
        const profilePageContent = document.getElementById('profilePageContent');
        const profileBackBtn = document.getElementById('profileBackBtn');
        const userNameInput = document.getElementById('userNameInput');
        const profileEmailDisplay = document.getElementById('profileEmailDisplay');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        const profileMessage = document.getElementById('profileMessage');
        const profileDarkModeToggle = document.getElementById('profileDarkModeToggle');
        const profileUserIdSpan = document.getElementById('profileUserIdSpan');
        const logoutBtn = document.getElementById('logoutBtn');
        const body = document.body;

        let messageTimeout = null; // voor profielpagina berichten

        // --- Hulpfuncties ---
        function showMessage(msg, isError = true) {
            profileMessage.textContent = msg;
            profileMessage.classList.remove('hidden', 'text-green-500', 'text-red-500');
            if (isError) {
                profileMessage.classList.add('text-red-500');
            } else {
                profileMessage.classList.add('text-green-500');
            }
            profileMessage.classList.add('animate-fade-in-down');

            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            messageTimeout = setTimeout(() => {
                profileMessage.classList.add('hidden');
                profileMessage.classList.remove('animate-fade-in-down');
            }, 3000);
        }

        function applyTheme() {
            isDarkMode = localStorage.getItem('isDarkMode') === 'true'; // Haal thema op uit localStorage

            if (isDarkMode) {
                body.classList.add('dark-mode');
                body.classList.remove('light-mode', 'bg-gradient-to-br', 'from-blue-100', 'to-purple-100', 'text-gray-800');
                body.classList.add('bg-gray-900', 'text-gray-100');

                profilePageContent.classList.add('dark-mode');
                profilePageContent.classList.remove('bg-white', 'border-gray-200');
            } else {
                body.classList.remove('dark-mode', 'bg-gray-900', 'text-gray-100');
                body.classList.add('light-mode', 'bg-gradient-to-br', 'from-blue-100', 'to-purple-100', 'text-gray-800');

                profilePageContent.classList.remove('dark-mode');
                profilePageContent.classList.add('bg-white', 'border-gray-200');
            }

            // Werk invoerveldstijlen bij
            document.querySelectorAll('.themed-input').forEach(input => {
                if (isDarkMode) {
                    input.classList.remove('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500', 'bg-white', 'text-gray-800');
                    input.classList.add('border-gray-500', 'focus:ring-blue-400', 'focus:border-blue-400', 'bg-gray-800', 'text-gray-100');
                } else {
                    input.classList.remove('border-gray-500', 'focus:ring-blue-400', 'focus:border-blue-400', 'bg-gray-800', 'text-gray-100');
                    input.classList.add('border-gray-300', 'focus:ring-blue-500', 'focus:border-blue-500', 'bg-white', 'text-gray-800');
                }
            });

            // Werk profiel terugknop thema bij
            if (profileBackBtn) {
                if (isDarkMode) {
                    profileBackBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                    profileBackBtn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                } else {
                    profileBackBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
                    profileBackBtn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                }
            }
        }

        // --- Firebase Initialisatie ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : `{
                    "apiKey": "AIzaSyB59BVbioUciigC0l47T1tQAsF_kPs2Frs",
                    "authDomain": "leer-app.firebaseapp.com",
                    "projectId": "leer-app",
                    "storageBucket": "leer-app.firebasestorage.app",
                    "messagingSenderId": "1029710103221",
                    "appId": "1:1029710103221:web:386173aefbed03015574fc"
                }`);

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        profileUserIdSpan.textContent = currentUserId;
                        profileEmailDisplay.value = user.email || '';
                        await loadUserProfile(); // Laad gebruikersprofiel (naam, donkere modus voorkeur)
                        applyTheme(); // Pas thema toe
                    } else {
                        // Gebruiker is NIET ingelogd, stuur door naar index.html
                        window.location.href = 'index.html';
                    }
                });
            } catch (error) {
                showMessage(`Fout bij initialiseren Firebase: ${error.message}`);
                console.error("Error initializing Firebase:", error);
                applyTheme();
            }
        }

        // --- Gebruikersprofiel Beheer (Firestore) ---
        async function loadUserProfile() {
            if (!db || !currentUserId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userProfile`, 'settings');

            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userName = data.name || 'Gast';
                    isDarkMode = data.isDarkMode || false;
                    localStorage.setItem('isDarkMode', isDarkMode); // Opslaan in local storage
                    userNameInput.value = userName; // Werk profielinvoer bij
                    profileDarkModeToggle.checked = isDarkMode; // Werk profielschakelaar bij
                    applyTheme(); // Pas thema toe op basis van geladen voorkeur
                } else {
                    await setDoc(userProfileDocRef, {
                        name: userName,
                        isDarkMode: isDarkMode
                    });
                    localStorage.setItem('isDarkMode', isDarkMode);
                }
            } catch (error) {
                showMessage(`Fout bij laden profiel: ${error.message}`);
                console.error("Error loading user profile:", error);
            }
        }

        async function saveUserProfile() {
            if (!db || !currentUserId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userProfile`, 'settings');

            try {
                await updateDoc(userProfileDocRef, {
                    name: userName,
                    isDarkMode: isDarkMode
                });
                localStorage.setItem('isDarkMode', isDarkMode);
                showMessage("Profiel opgeslagen!", false);
            } catch (error) {
                showMessage(`Fout bij opslaan profiel: ${error.message}`);
                console.error("Error saving user profile:", error);
            }
        }

        // --- Profielpagina Specifieke Functies ---
        async function handleUpdatePassword() {
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmNewPasswordInput.value.trim();
            profileMessage.textContent = '';

            if (!newPassword && !confirmPassword) {
                showMessage("Voer een nieuw wachtwoord in.");
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessage("Wachtwoorden komen niet overeen.");
                return;
            }
            if (newPassword.length < 6) {
                showMessage("Wachtwoord moet minimaal 6 tekens lang zijn.");
                return;
            }

            try {
                await updatePassword(auth.currentUser, newPassword);
                showMessage("Wachtwoord succesvol gewijzigd!", false);
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
            } catch (error) {
                let errorMessage = "Fout bij wijzigen wachtwoord.";
                if (error.code === 'auth/weak-password') {
                    errorMessage = "Het nieuwe wachtwoord is te zwak.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Voor deze actie moet je opnieuw inloggen. Log uit en weer in.";
                }
                showMessage(errorMessage);
                console.error("Password update error:", error);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged zal doorsturen naar index.html
            } catch (error) {
                showMessage(`Fout bij uitloggen: ${error.message}`);
                console.error("Logout error:", error);
            }
        }

        // --- Event Listeners voor Profielpagina ---
        profileBackBtn.onclick = () => {
            window.location.href = 'home.html'; // Navigeer terug naar de hoofdapp
        };

        userNameInput.onchange = () => {
            userName = userNameInput.value;
            saveUserProfile();
        };

        profileDarkModeToggle.onchange = () => {
            isDarkMode = profileDarkModeToggle.checked;
            localStorage.setItem('isDarkMode', isDarkMode);
            applyTheme();
            saveUserProfile();
        };

        updatePasswordBtn.onclick = handleUpdatePassword;
        logoutBtn.onclick = handleLogout;

        // --- Initiële Setup bij Venster Laden ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
